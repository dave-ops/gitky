<!-- public/files.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gitky - Files</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Uploaded Files</h1>
        <p id="repoInfo"></p>
        <p id="currentPath">Path: /</p>
        <ul id="fileList" class="file-list"></ul>
        <div id="fileContent" class="file-content"></div>
        <a href="/">Back to Upload</a>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user');
        const repo = urlParams.get('repo');
        const branch = urlParams.get('branch');
        let currentPath = '';

        document.getElementById('repoInfo').textContent = `Repository: ${user}/${repo} (Branch: ${branch})`;

        async function loadFiles(path = '') {
            const fileList = document.getElementById('fileList');
            const fileContent = document.getElementById('fileContent');
            fileContent.textContent = '';
            document.getElementById('currentPath').textContent = `Path: /${path}`;

            try {
                const response = await fetch(`/files?user=${user}&repo=${repo}&branch=${branch}&path=${path}`);
                const items = await response.json();
                console.log('Fetched items:', items); // Debug: Check what’s returned

                fileList.innerHTML = '';
                if (items.length === 0) {
                    fileList.innerHTML = '<li>No files or folders found.</li>';
                } else {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        const name = item.filePath.split('/').pop();
                        li.textContent = `${item.isDirectory ? '📁' : '📄'} ${name}`;
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', () => {
                            console.log('Clicked:', item.filePath, 'Is Directory:', item.isDirectory); // Debug
                            if (item.isDirectory) {
                                currentPath = item.filePath;
                                loadFiles(currentPath);
                            } else {
                                showFileContent(item.filePath);
                            }
                        });
                        fileList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Error loading files:', error);
                fileList.innerHTML = '<li>Error loading files.</li>';
            }
        }

        async function showFileContent(filePath) {
            const fileContent = document.getElementById('fileContent');
            console.log('Fetching content for:', filePath); // Debug
            try {
                const response = await fetch(`/file?user=${user}&repo=${repo}&branch=${branch}&filePath=${filePath}`);
                const content = await response.text();
                console.log('Response status:', response.status, 'Content:', content); // Debug
                if (response.ok) {
                    fileContent.textContent = content;
                } else {
                    fileContent.textContent = `Error: ${content}`;
                }
            } catch (error) {
                fileContent.textContent = 'Error loading file content.';
                console.error('Error fetching file content:', error);
            }
        }

        loadFiles();
    </script>
</body>
</html>